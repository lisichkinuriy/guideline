# Contract

Мы делаем интеграции с внешними API.   
Значит нужен Contract testing, unit тесты с Laravel Http::fake().  

Это не альтернатива Mock сервисам вроде https://docs.pact.io/ или https://mockoon.com/  
Контракты в коде решают задачу юнит тестирования, мок-сервисы - нужны для компонентных тестов.

Одни контракт = один endpoint внешнего API.  

Контракт знает о: 
- своем URL
- как подготовить request
- какие данные нужны для Http::fake успеха и ошибки 

Из контрактов собираются Client - клиенты внешних апи

в PHPDoc добавляем ссылку на доку API

пример контракта
```php
/**
* https://ssikla-na-doku-k-api.ru/sadfasd/sadfsd
*/
final readonly class PayoutCreateContract
{
    public function __construct(
        public string $base_url = "http://localhost",
        public ?ProcessingOrderID $orderID = null
    ) {
        if (null === $orderID) {
            $this->orderID = ProcessingOrderID::fake();
        }
    }
    
    public function url(): string {
        return $this->base_url . "/api/v1/payout";
    }

    public function request(
        ProcessingOrderID $orderID,
        ProcessingSenderID $senderID,
        ProcessingReceiverID $receiverID,
        CommissionAmount $amount
    ): array {
        return [
            "order_id" => $orderID->value,
            "sender_id" => $senderID->value,
            "receiver_id" => $receiverID->value,
            "purpose" => "OrderID: " . $orderID->value,
            "amount" => $amount->value,
            "currency" => "RUB",
        ];
    }

    public function successResponse(ProcessingPayoutID $processingPayoutID): PromiseInterface
    {
        return Http::response('{
          "status": true,
          "result": {
            "payout_id": "'. $processingPayoutID->value . '",
            "order_id": "'.$this->orderID->value.'",
            "status": "new",
            "bank_status": null,
            "bank_error": null,
            "created_at": "2025-03-28T13:57:51.000000Z",
            "updated_at": "2025-03-28T13:57:51.000000Z",
            "statement": null
          },
          "message": null
        }', 200);
    }



    public function errorResponse(): PromiseInterface
    {
        return Http::response('{
          "message": "Некорректный SenderID",
          "errors": {
            "SenderID": [
              "Некорректный SenderID"
            ]
          }
        }', 422);
    }
}
```

Пример использования в Client
```php
    public static function createPayout(
        Commission $commission,
        ProcessingSenderID $senderID,
        ProcessingReceiverID $receiverID
    ): ?ProcessingPayoutDTO {
        $contract = new PayoutCreateContract(ProcessingUtils::url());

        $request = $contract->request(
            new ProcessingOrderID($commission->getId()->value),
            $senderID,
            $receiverID,
            $commission->getAmount()
        );

        $response = Http::post($contract->url(), $request);

        if ($response->ok()) {
            return ProcessingPayoutDTO::fromCreateResponse($response->json());
        }

        return null;
    }
```


