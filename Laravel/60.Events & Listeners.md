# Events & Listeners

- Event регистрируется внутри доменных методов и диспетчится в момент коммита UnitOfWork.
- Event это всегда Доменный Event
- Event это способ передачи управления из модуля (крупного блока кода) в другой
- Общение между модулями происходит через очереди, поэтому ответственность Listener - это только Dispatch необходимой Джобы.
- Джоба - это необходимый разрыв процесса выполнения кода через очередь.


Плохой пример
```php
$card->issue();
CardIssueCreated::dispatch($card);
```

Хороший пример
```php

$card->issue();
$uow->add($card)->commit();

trait CardDomain {
    public function issue(): self {
        $this->state = "some value";
        $this->dispatchDomainEvent(CardIssueCreated::class, $this);
        return $this;
    }
}
```

Пример Listener
```php
class PostbackListener
{
    public function handle(CardIssueCreated|CardIssueFailed $event): void
    {
        InitPostbackJob::dispatch($event->card->getID());
    }
}
```

Пример юнит теста
```php
public function test_event(): void
{
    Event::fake();
    Event::assertListening(CardIssueCreated::class, PostbackListener::class);
    Event::assertListening(CardIssueFailed::class, PostbackListener::class);
}
```


Пример юнит теста
```php
public function test_listener(): void
{
    Queue::fake();
    $event = new CardIssueCreated();
    $listener = new PostbackListener();
    $listener->handle($event);
    
    Queue::assertPushed(InitPostbackJob::class);
}
```
