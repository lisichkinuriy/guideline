# Репозитории баз данных

- содержат выборки из базы данных необходимые для операций DDD
- реализуют интерфейс
- имеют Mock версии для развязки от базы данных
- Регистрируются в ServiceProvider, например AppServiceProvider

Интерфейс
```php
interface ICommissionSettingsRepository
{
    public function getForEmployer(EmployerName $employerName): ?CommissionSettings;
    public function getCommon(): ?CommissionSettings;
    public function getForEmployerOrCommon(EmployerName $employerName): ?CommissionSettings;
}
```

Eloquent реализация
```php
class CommissionSettingsRepository implements ICommissionSettingsRepository
{
    public function getForEmployer(EmployerName $employerName): ?CommissionSettings
    {
        return CommissionSettings::query()
            ->where(CommissionSettings::EMPLOYER_NAME, $employerName->value)
            ->first();
    }

    public function getCommon(): ?CommissionSettings
    {
        return CommissionSettings::query()
            ->where(CommissionSettings::EMPLOYER_NAME, EmployerName::common()->value)
            ->first();
    }

    public function getForEmployerOrCommon(EmployerName $employerName): ?CommissionSettings
    {
        $settings = $this->getForEmployer($employerName);
        if (null !== $settings) {
            return $settings;
        }

        return $this->getCommon();
    }
}
```

Mock реализация
```php
class CommissionSettingsRepositoryMock implements ICommissionSettingsRepository
{
    public static function bind(
        ?CommissionSettings $settings = null
    ): void {
        app()->bind(
            ICommissionSettingsRepository::class,
            fn () => new CommissionSettingsRepositoryMock($settings)
        );
    }

    public function __construct(
        public ?CommissionSettings $settings = null
    ) {
    }

    public function getForEmployer(EmployerName $employerName): ?CommissionSettings
    {
        return $this->settings;
    }

    public function getCommon(): ?CommissionSettings
    {
        return $this->settings;
    }

    public function getForEmployerOrCommon(EmployerName $employerName): ?CommissionSettings
    {
        return $this->settings;
    }
}
```

регистрация в провайдере
```php
class AppServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        app()->bind(ICommissionSettingsRepository::class, CommissionSettingsRepository::class);
    }
}
```

использование в Action
```php
class SetCommissionSettingsAction implements IAction
{
    public function __construct(public ICommissionSettingsRepository $settingsRepository) {
    }

    public static function mock(?CommissionSettings $settings = null)
    {
        CommissionSettingsRepositoryMock::bind($settings);
    }

    public function execute(SetCommissionSettingsDTO $dto): ActionResultDTO
    {
        $settings = $this->settingsRepository->getForEmployer($this->dto->employerName);
        if (null === $settings) {
    
        } else {

        }
        
        ... bla bla
    }
}
```