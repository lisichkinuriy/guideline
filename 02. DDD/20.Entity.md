# Entity
коротко - это наши модельки.

- имеют конструкторы и методы изменения состояния, валидируют свою консистентность
- позволяют изменять своё состояние без обращения к базе данных
- имеют PHPDoc с описанием @property
- оперируют VO
- умеют себя зафейкать
- implements IDomainEntity  через   use HasDomainEvents;  создаёт доменные события, через addDomainEvent

- работу с базой данных оставляем в классе модели элокента
- конструкторы, методы, фэйки - это наша зона ответственности, размещаем её отдельно от фреймворка - в Trait


пример, модель Eloquent, использующая Trait
```php
class Commission extends Model implements IDomainEntity
{
    use CommissionDomain;
    use HasUuids;
    use SoftDeletes;

    public $preventsLazyLoading = true;

    public const string STATUS = 'status';
    public const string EMPLOYEE_ID = 'employee_id';
    public const string EMPLOYER = "employer";

    protected function casts(): array
    {
        return [
            self::STATUS => CommissionStatus::class,
        ];
    }
}
```

пример, трейта Domain
```php
/**
 * @property string $id
 * @property string $employee_id
 * @property Employee $employee
 * @property string $split_id
 * @property int $amount
 * @property string $employer
 * @property CommissionStatus $status
 * @property int $current_round
 */
trait CommissionDomain
{
    use HasDomainEvents;
    use CommissionFake;

    public static function createForSplit(
        SplitID           $splitID,
        GatewayEmployeeID $employeeID,
        PayoutAmount $payout_amount,
        EmployerName $employer,
        CommissionSettings $settings,
    ): self {

        if ($payout_amount->equals(PayoutAmount::zero())) {
            throw new DomainException(DomainErrorCode::WE_DONT_CREATE_COMMISSIONS_FOR_ZERO_PAYOUT);
        }

        $amount = $settings->calcCommission($payout_amount);

        $model = new self();
        $model->id = CommissionID::generate()->value;
        $model->employee_id = $employeeID->value;
        $model->amount = $amount->value;
        $model->split_id = $splitID->value;
        $model->status = CommissionStatus::WAIT_PROCESSING;
        $model->employer = $employer->value;
        $model->current_round = CommissionRound::zero()->value;
        $model->addDomainEvent(CommissionCreated::class, $model);
        
        return $model;
    }

    public function getId(): CommissionID
    {
        return new CommissionID($this->id);
    }
       
    public function getAmount(): CommissionAmount
    {
        return new CommissionAmount($this->amount);
    }
    
    public function isPaid(): bool
    {
        return $this->status === CommissionStatus::PAID;
    }

    public function startNextRound(): self
    {
        $new = new CommissionRound($this->current_round + 1);
        $this->current_round = $new->value;
        return $this;
    }

    public function setPaid(): self
    {
        $this->status = CommissionStatus::PAID;
        $model->addDomainEvent(CommissionPaid::class, $model);
        return $this;
    }

}
```

пример трейта с фейк методами
```php
trait CommissionFake
{
    public static function fake(
        SplitID            $splitID = null,
        GatewayEmployeeID  $employeeID = null,
        PayoutAmount       $payoutAmount = null,
        EmployerName       $employerName = null,
        CommissionSettings $commissionSettings = null
    ): self {
        if (null === $splitID) {
            $splitID = SplitID::fake();
        }
        if (null === $employeeID) {
            $employeeID = GatewayEmployeeID::fake();
        }
        if (null === $payoutAmount) {
            $payoutAmount = PayoutAmount::fake();
        }
        if (null === $employerName) {
            $employerName = EmployerName::fake();
        }
        if (null === $commissionSettings) {
            $commissionSettings = CommissionSettings::fake();
        }

        return self::createForSplit(
            $splitID,
            $employeeID,
            $payoutAmount,
            $employerName,
            $commissionSettings
        );
    }
}
```

Пример использования в юнит тестах
```php
class CommissionRepayedTest extends TestCase
{
    public function test_commission_repayed_send_to_rabbit(): void
    {
        RabbitPublisher::bindFake();

        $commission = Commission::fake();
        $commission->setPaid();

        $job = new CommissionRepayedProducer($commission);
        $job->handle();

        /** @var CommissionRepayedMsg $msg */
        $msg = FakeRabbitPublisher::getPublishedMsg();
        $this->assertEquals($msg->commissionId->value, $commission->id);
        $this->assertEquals($msg->amount->value, $commission->amount);
        $this->assertEquals($msg->splitID->value, $commission->split_id);
        $this->assertEquals($msg->employeeGatewayID->value, $commission->employee_id);
    }
}

```