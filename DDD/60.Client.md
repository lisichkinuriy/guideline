# Client

Это клиент внешних API, интерфейс которого реализован в терминах нашей предметной области.
Может использоваться в DI, может резолвиться фабрикой.

- реализует интерфейс
- знает о всех необходимых себе контрактах, и знает как их зафейкать
- может иметь Sandbox реализацию


пример, инетерфейс
```php
interface IBalanceClient
{
    public function getBalance(): TKassaBalanceAvailable;
}
```

пример, песочная реализация
```php
final class SandboxBalanceClient implements IBalanceClient
{
    public function getBalance(): TKassaBalanceAvailable
    {
        return new TKassaBalanceAvailable(777_777_77);
    }
}
```

пример, HTTP реализация
```php
class BalanceClient  implements IBalanceClient
{
    ... 

    public function getBalance(): TKassaBalanceAvailable
    {
        $contract = new TKassaGetAccountInfoContract;
        $response = $this->requestPOST(
            $contract->url(),
            $contract->request($this->access->terminalKey)
        );

        return TKassaBalanceAvailable::fromTKassaResponse($response);
    }

    public function fakeHttpResponses(int $expected_balance): array
    {
        $contract = new TKassaGetAccountInfoContract($expected_balance);
        return [
            $contract->url() => $contract->successResponse(),
        ];
    }
}
```

пример фабрики-резолвера
```php
public static function getBalanceClient(Sender $sender): IBalanceClient
{
    if (SandboxFlag::isSandbox()) {
        return new SandboxBalanceClient;
    }

    $t_kassa_access = TKassaAccess::fromArray($sender->access);
    return new BalanceClient($t_kassa_access);
}
```

пример использования в Action
```php

  $apiClient = ClientResolver::getBalanceClient($sender);
  $balance = $apiClient->getBalance();

```

пример теста для резолвера клиентов
```php
public static function balance_clients(): array
{
    return [
        [fn () => Sender::fakeTKassa(), BalanceService::class],
    ];
}

#[DataProvider('balance_clients')]
public function test_get_balance_client(
    Closure $sender_f,
    string $expectedClass
) {
    Config::set('sandbox.enabled', false);

    $sender = $sender_f();
    $apiClient = ClientResolver::getBalanceClient($sender);
    $this->assertEquals($expectedClass, $apiClient::class);
}
```


Пример юнит теста клиента
```php
public function test_processing_api_create_check(): void
{
    $checkId = ProcessingCheckID::fake();
    Http::fake(CheckClient::successResponses($checkId));

    $proc_check_id = CheckClient::createCheck(ProcessingPayoutID::fake(), Phone::fake());

    $this->assertTrue($checkId->equals($proc_check_id));
}

public function test_fails_processing_api_create_check(): void
{
    Http::fake(CheckClient::errorResponses());

    $proc_check_id = CheckClient::createCheck(ProcessingPayoutID::fake(), Phone::fake());

    $this->assertFalse($proc_check_id);
}
```