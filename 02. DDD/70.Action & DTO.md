# Action и DTO


## Action
в других терминах - оно же UseCase, оно же CommandHandler и Command.

Собственно это и есть само действие, которое должно выполнить наше приложение.  
- "Инициализирвоать выплату"
- "Узнать статус выплаты"
- "Удалить пользователя"
- "Отправить отчет"  


Action - точка инъекции зависимостей, интерфейсов
- Repository
- UnitOfWork
- Clients

Action
- знает как себя замокать для тестов
- возвращает ActionResultDTO
- это граница транзакций


Один процесс PHP = один Action, одна транзакция в БД.  
Если код требует последовательного вызова нескольких Action -  
значит нужно сделать разрыв в таком коде через очередь и джобу.


## DTO - Data Transfer Object  
Объект для передачи данных между слоями приложения,
- из слоя фреймворка в Action
- и из Action обратно

DTO знает как себя зафейкать, имеет конструкторы из необходимых источников данных (обычно это Request)


пример DTO
```php
final readonly class StoreAgentDTO
{
    public function __construct(
        public RequisiteTBankTerminal $bankTerminal
    ) {
    }

    public static function fake(): self
    {
        return new self(RequisiteTBankTerminal::fake());
    }

    public static function fromRequest(SetAgentRequisiteRequest $request): self
    {
        return new self(
            new RequisiteTBankTerminal(
                new RequisiteTerminalKey($request->validated(SetAgentRequisiteRequest::TERMINAL_KEY)),
                new RequisitePassword($request->validated(SetAgentRequisiteRequest::PASSWORD))
            )
        );
    }
}
```


пример Action
```php
class StoreAgentAction
{
    public function __construct(
        public IAgentRepository $agentRepo,
        public IUnitOfWork $uow 
    ) {
    }

    public static function mock(?Agent $agent = null): void
    {
        FakeUnitOfWork::bind();
        AgentRepositoryMock::bind($agent);
    }

    public function execute(StoreAgentDTO $dto): ActionResultDTO
    {
        if (null !== $this->agentRepo->getSingleton()) {
            return ActionResultDTO::fail(DomainErrorCode::SYSTEM_ALREADY_HAS_AGENT);
        }

        $agent = Agent::new(AgentID::generate());

        $this->uow->add($agent);
        $this->uow->addJob(AgentSendToProcessingJob::class, $agent->getId(), $dto->bankTerminal);
        $this->uow->commit();

        return ActionResultDTO::success($agent);
    }

    public function getResultAgent(ActionResultDTO $resultDTO): Agent
    {
        return $resultDTO->result;
    }
}
```

пример unit тестов Action
```php
class StoreAgentActionTest extends TestCase
{
    public function test_store_agent_action(): void
    {
        StoreAgentAction::mock(null);

        $dto = StoreAgentDTO::fake();
        $action = new StoreAgentAction();
        $result = $action->execute($dto);
        $agent = $action->getResultAgent($result);

        $this->assertTrue($result->isSuccess());
        Queue::assertPushed(AgentSendToProcessingJob::class);
        $this->assertNull($agent->processing_receiver_id);
    }

    public function test_can_not_store_second_agent()
    {
        $agent = Agent::new(AgentID::fake());
        StoreAgentAction::mock($agent);

        $dto = StoreAgentDTO::fake();
        $action = new StoreAgentAction();
        $result = $action->execute($dto);
        $this->assertTrue($result->isFail());
    }
}
```
